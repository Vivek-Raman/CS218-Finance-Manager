# Environment Variables Management

## Overview

This project uses two types of environment variable files:

1. **`.env`** (project root) - For local development (frontend/backend)
2. **`terraform.tfvars`** (infra/) - For Terraform/OpenTofu infrastructure variables

## Terraform Variables (`terraform.tfvars`)

### Location
- File: `infra/terraform.tfvars`
- Template: `infra/terraform.tfvars.example`
- Status: **Gitignored** (never commit this file!)

### Setup

1. **Copy the example file:**
   ```bash
   cd infra
   cp terraform.tfvars.example terraform.tfvars
   ```

2. **Edit `terraform.tfvars` and add your values:**
   ```hcl
   openai_api_key = "sk-your-actual-key-here"
   openai_model   = "gpt-3.5-turbo"
   ```

3. **Deploy:**
   ```bash
   make tofu-apply
   # or
   cd infra && tofu apply -var-file=terraform.tfvars
   ```

### Variables

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `openai_api_key` | ✅ Yes | - | OpenAI API key for AI categorization |
| `openai_model` | No | `gpt-3.5-turbo` | OpenAI model to use |
| `aws_region` | No | `us-west-1` | AWS region |
| `app_name` | No | `finance-manager` | Application name |
| `amplify_repository` | No | `""` | Amplify Git repository |
| `amplify_branch` | No | `main` | Amplify branch |
| `cognito_callback_url` | No | `http://localhost:5173` | Cognito callback URL |

### Alternative: Environment Variables

You can also set Terraform variables via environment variables:

```bash
export TF_VAR_openai_api_key="sk-..."
export TF_VAR_openai_model="gpt-3.5-turbo"
cd infra && tofu apply
```

Or inline:
```bash
cd infra && tofu apply -var="openai_api_key=sk-..."
```

## Local Development Variables (`.env`)

### Location
- File: `.env` (project root)
- Status: **Gitignored**

### Generated by Makefile

The `.env` file is automatically generated from OpenTofu outputs:

```bash
make save-env
```

This creates/updates `.env` with:
- API Gateway URL
- DynamoDB table name
- Cognito configuration
- Frontend environment variables

### Manual Editing

You can also manually edit `.env` for local development:

```bash
# .env
VITE_API_URL=https://api.example.com
OPENAI_API_KEY=sk-...  # For local testing only
```

### Loading for Development

```bash
# Load environment variables
source .env

# Or use Makefile
make dev-local  # Automatically loads .env
```

## Security Best Practices

1. **Never commit sensitive files:**
   - ✅ `terraform.tfvars` is in `.gitignore`
   - ✅ `.env` is in `.gitignore`

2. **Use different keys for different environments:**
   - Development: Local `.env` or `terraform.tfvars`
   - Production: AWS Secrets Manager or environment variables

3. **Rotate keys regularly:**
   - Update `terraform.tfvars` and redeploy
   - Update Lambda environment variables

## Current Setup

### For Infrastructure (Terraform/OpenTofu)
- **File:** `infra/terraform.tfvars`
- **Used by:** `make tofu-apply`, `make tofu-plan`
- **Contains:** OpenAI API key, AWS region, app name, etc.

### For Local Development
- **File:** `.env` (project root)
- **Used by:** `make dev-local`, frontend/backend development
- **Generated by:** `make save-env` (from OpenTofu outputs)

## Example Workflow

### Initial Setup
```bash
# 1. Copy example file
cd infra
cp terraform.tfvars.example terraform.tfvars

# 2. Edit terraform.tfvars with your OpenAI key
nano terraform.tfvars

# 3. Deploy infrastructure
cd ..
make tofu-apply

# 4. Save environment variables for local dev
make save-env
```

### Updating OpenAI Key
```bash
# 1. Edit terraform.tfvars
cd infra
nano terraform.tfvars  # Update openai_api_key

# 2. Apply changes
cd ..
make tofu-apply  # Updates Lambda environment variables
```

### Local Development
```bash
# 1. Ensure .env exists (generated from infrastructure)
make save-env

# 2. Start development server
make dev-local  # Loads .env automatically
```

## Troubleshooting

### "openai_api_key variable is required"
- Create `infra/terraform.tfvars` from `infra/terraform.tfvars.example`
- Add your OpenAI API key

### "terraform.tfvars not found"
- The Makefile will warn but continue
- Variables can be set via environment variables or command line
- Best practice: Create `terraform.tfvars` file

### Variables not updating
- After changing `terraform.tfvars`, run `make tofu-apply`
- Lambda environment variables update automatically
- No need to rebuild Lambda packages
